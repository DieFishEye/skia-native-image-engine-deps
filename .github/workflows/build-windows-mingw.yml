name: build-skia-windows-mingw

on:
  workflow_dispatch:

jobs:
  windows_mingw:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) 安装 Git for Windows（depot_tools/gclient 在 Windows 上非常依赖它）
      - name: Install Git for Windows (choco)
        shell: pwsh
        run: |
          choco install git -y
          git --version

      # 2) 拉 depot_tools
      - name: Fetch depot_tools
        shell: pwsh
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git $env:USERPROFILE\depot_tools

      # 3) gclient sync Skia（关键：--nohooks 避免 activate-emsdk 之类的东西）
      - name: Sync Skia deps (gclient sync --nohooks)
        shell: pwsh
        run: |
          $env:PATH = "$env:USERPROFILE\depot_tools;$env:PATH"

          New-Item -ItemType Directory -Force -Path skia | Out-Null
          Set-Location skia

          @"
          solutions = [
            {
              "name": "skia",
              "url": "https://skia.googlesource.com/skia.git",
              "deps_file": "DEPS",
              "managed": False,
              "custom_deps": {},
            },
          ]
          "@ | Out-File -Encoding ascii .gclient

          gclient sync --nohooks --with_branch_heads --with_tags

      # 4) 安装 MSYS2 + MinGW64 工具链（负责编译）
      - name: Setup MSYS2 (mingw64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            python
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-clang

      # 5) 编译 Skia（在 MSYS2 环境跑 gn/ninja）
      - name: Build Skia (mingw64 cpu-only)
        shell: msys2 {0}
        run: |
          set -eux

          # depot_tools 在 Windows 用户目录中，MSYS2 下路径是 /c/Users/<user>/depot_tools
          export PATH="/c/Users/runneradmin/depot_tools:$PATH"

          cd skia/skia

          # CPU-only + 裁剪大模块（先求能编出来）
          gn gen out/imgconv --args='
            is_official_build=true
            is_component_build=false
            skia_enable_gpu=false
            skia_enable_skshaper=false
            skia_enable_pdf=false
          '

          ninja -C out/imgconv

      # 6) 打包产物：include + *.a
      - name: Package artifacts
        shell: msys2 {0}
        run: |
          set -eux

          mkdir -p out_pkg/windows_amd64/lib
          mkdir -p out_pkg/windows_amd64/include

          # 头文件（先全拷，后续你可以裁剪）
          cp -r skia/skia/include out_pkg/windows_amd64/include/

          # 收集 out/imgconv 下的静态库
          find skia/skia/out/imgconv -maxdepth 1 -type f -name "*.a" -print -exec cp {} out_pkg/windows_amd64/lib/ \;

          # 打 zip
          cd out_pkg
          python -c "import shutil; shutil.make_archive('skia-windows_amd64', 'zip', 'windows_amd64')"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: skia-windows_amd64
          path: out_pkg/skia-windows_amd64.zip
