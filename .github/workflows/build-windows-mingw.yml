name: build-skia-windows-mingw

on:
  workflow_dispatch:

jobs:
  windows_mingw:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Git for Windows（depot_tools/gclient 需要原生 git.exe）
      - name: Install Git for Windows (choco)
        shell: pwsh
        run: |
          choco install git -y
          git --version

      # 2) depot_tools
      - name: Fetch depot_tools
        shell: pwsh
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git $env:USERPROFILE\depot_tools

      # 3) gclient sync（不跑 hooks，先只拉代码+deps）
      - name: Sync Skia deps (gclient sync --nohooks)
        shell: pwsh
        run: |
          $env:PATH = "$env:USERPROFILE\depot_tools;$env:PATH"

          New-Item -ItemType Directory -Force -Path skia | Out-Null
          Set-Location skia

          @"
          solutions = [
            {
              "name": "skia",
              "url": "https://skia.googlesource.com/skia.git",
              "deps_file": "DEPS",
              "managed": False,
              "custom_deps": {},
            },
          ]
          "@ | Out-File -Encoding ascii .gclient

          gclient sync --nohooks --with_branch_heads --with_tags

      # 4) ✅ 关键：安装 GN（不依赖 Skia checkout 自带的 gn.exe）
      # 使用 depot_tools 自带的 python 脚本去拉 buildtools（含 gn.exe）
      - name: Install GN (download prebuilt)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # ✅ 你可以放到工作目录里
          $gnDir = "$env:GITHUB_WORKSPACE\_tools\gn"
          New-Item -ItemType Directory -Force -Path $gnDir | Out-Null

          # ✅ 下载 gn.exe（Windows x64）
          # 这个地址是 Chromium 官方常用的 gn 输出位置（若未来变动，我再帮你换）
          $url = "https://chrome-infra-packages.appspot.com/dl/gn/gn/windows-amd64/+/latest"

          Write-Host "Downloading GN from $url ..."
          $zipPath = "$gnDir\gn.zip"
          Invoke-WebRequest -Uri $url -OutFile $zipPath

          Expand-Archive -Path $zipPath -DestinationPath $gnDir -Force

          # ✅ 有些包会在子目录里，直接搜索 gn.exe
          $gnExe = Get-ChildItem -Path $gnDir -Recurse -Filter "gn.exe" | Select-Object -First 1
          if (-not $gnExe) { throw "gn.exe not found after unzip" }

          Write-Host "GN located at: $($gnExe.FullName)"

          # ✅ 加到 PATH（对后续 step 生效）
          echo $gnExe.Directory.FullName | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          # ✅ 验证
          & $gnExe.FullName --version

      # 5) MSYS2 + MinGW64（只用于编译）
      - name: Setup MSYS2 (mingw64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            python
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-clang

      # 6) Build（用 depot_tools 的 gn / ninja）
      - name: Build Skia (mingw64 cpu-only)
        shell: msys2 {0}
        run: |
          set -eux

          # depot_tools 在 Windows 用户目录
          export PATH="/c/Users/runneradmin/depot_tools:$PATH"

          # ✅ 必须能找到 gn
          gn --version

          cd skia/skia

          # 先求能编出来：CPU-only + 关大模块
          gn gen out/imgconv --args='is_official_build=true is_component_build=false skia_enable_gpu=false skia_enable_skshaper=false skia_enable_pdf=false'
          ninja -C out/imgconv

      # 7) 打包
      - name: Package artifacts
        shell: msys2 {0}
        run: |
          set -eux

          mkdir -p out_pkg/windows_amd64/lib
          mkdir -p out_pkg/windows_amd64/include

          cp -r skia/skia/include out_pkg/windows_amd64/include/

          find skia/skia/out/imgconv -maxdepth 1 -type f -name "*.a" -print -exec cp {} out_pkg/windows_amd64/lib/ \;

          cd out_pkg
          python -c "import shutil; shutil.make_archive('skia-windows_amd64', 'zip', 'windows_amd64')"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: skia-windows_amd64
          path: out_pkg/skia-windows_amd64.zip
